#!/usr/bin/env zsh

ETCD_PORT=$ETCD_PORT

# if no args - print usage
if [[ $# -lt 0 ]];then
  echo "Usage: [debug,env,port]"
  echo "\tshell -- open a docker shell"
  echo "\tenv -- set env to some value"
  echo "\tport -- set port to some value" 

  echo "\nExample Usage:"
  echo "\tmac shell -- run -i -t shell exposed on $ETCD_PORT"
  echo "\tmac dev -- run a docker etcd daemon with the dev seed file"
  echo "\tmac dev 4002 -- same as mac dev but with 4002 instead of $ETCD_PORT"
  echo "\tmac 4002 -- defaults, exposed on different port tho"
  return 0
fi

# regex to match a number
int_re='^[0-9]+$'

port=$ETCD_PORT # use default port unless specified
cmd_type=daemon # run as daemon unless shell is passed
env=dev # seed dev.toml by default

# iterate through arguments
for arg in "$@";do
  if [[ $arg =~ $int_re ]];then
    port=$arg
  elif [[ $arg == "shell" ]];then
    cmd_type=$arg
  else
    env=$arg
  fi
done

# now create command to be run
if [[ $cmd_type == "shell" ]];then
  docker run -i -t -p $port:$port -e "ETCD_HOST=$ETCD_HOST ETCD_PORT=$port ENV=$env" \
    --entrypoint=/bin/bash docker-etcd -s
else
  docker run -d -t -p $port:$port -e "ETCD_HOST=$ETCD_HOST ETCD_PORT=$port ENV=$env" \
    docker-etcd
fi


