#!/usr/bin/env bash
# all job control
set -m

# start etcd with the correct parameters
/opt/etcd/bin/etcd $@ &

# use seed file if needed
if [[ ! -z "$SEED" ]];then

  filepaths=(
   "$SEED"
   "$SEED.toml" 
   "$SEED_PATH/$SEED" 
   "$SEED_PATH/$SEED.toml"
  )

  # generate the seed file path
  for i in "${filepaths[@]}"
  do
    # seed the etcd dir if file exists
    if [[ -f "$i" ]];then
      etcd-seed $i
    fi
  done

# try to find default seed file etc
elif [[ ! "$(echo $ENV | awk '{ print tolower($0) }')" == "production" ]];then
  filepath="$SEED_PATH/$(echo $ENV | awk '{ print tolower($0) }').toml"
  if [[ -f $filepath ]];then
    echo "Filepath $filepath doesn't exist"
  else
    etcd-seed $filepath
  fi
fi

# bring etcd back to life!
fg
